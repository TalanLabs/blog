<!DOCTYPE html>
<html lang='fr-FR'>
<head><meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/>

<title>Talan Labs | Blog</title>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-112601921-3"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'UA-40718882-5');
</script>

<link rel="icon" type="image/png" sizes="96x96" href='/img/favicon.png'>

<link rel="canonical" href="https://blog.talanlabs.com/elasticsearch-back-to-the-future/">

<link rel="stylesheet" href='/css/bootstrap.min.css' type='text/css'/>
<link rel="stylesheet" href='/css/gaia.css' type='text/css'/>
<link rel="stylesheet" href='/css/fontawesome.min.css' type='text/css'/>
<link rel="stylesheet" href='/css/custom.css' type='text/css'/>

<link href='https://fonts.googleapis.com/css?family=Cambo|Lato:400,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div class="content"><nav class="navbar navbar-expand-lg navbar-light fixed-top">
  <div class="container">
    <a class="navbar-brand" href='/'><img src='/img/logo_talanlabs_white_small.png' alt="Logo Talan Labs"/></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav mr-auto"></ul>
      <ul class="navbar-nav float-right">
        
        <li><a href="/categories" target="_parent">Les Labs</a></li>
        
        <li><a href="/tags" target="_parent">#Tags</a></li>
        
        <li><a href="/authors" target="_parent">Les Auteurs</a></li>
        
        <li><a href="https://talan.com/metiers/labs" target="_parent">Talan Labs</a></li>
        
      </ul>
    </div>
  </div>
</nav>





<div class="section section-header section-header-blog">
    <div class="parallax filter filter-color-black">
        <div class="image" style="background-image: url('/work-in-progress.jpg')"></div>
        <div class="container">
            <div class="content">
                <h1>ElasticSearch, back to the future</h1>
            </div>
        </div>
    </div>
</div>

<div class="section">
    <div class="container">
        <div class="row">
            <div class="col">
                <h1>ElasticSearch, back to the future</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="content-blog">

<p><img src="/logo_es.jpg" alt="" /></p>

<p>Je me suis remis à ElasticSearch après plusieurs années d&rsquo;absence et le choc a été dur : revenir à Oracle après 5 ans, pas de souci, mais dans le cas d&rsquo;Elasticsearch, ça avait tellement évolué que j&rsquo;ai du prendre un peu de temps pour m&rsquo;y remettre.</p>

<p>Que s&rsquo;est-il donc passé entre un <strong><a href="https://www.elastic.co/downloads/past-releases/elasticsearch-0-90-5">ES 0.90.5 de 2013</a></strong> et un <strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/release-notes-6.5.4.html">ES 6.5.4 de 2019</a></strong> ?</p>

<h2 id="mes-usages"><strong>Mes usages</strong></h2>

<h4 id="2013-cadremploi">2013 - Cadremploi</h4>

<p>En 2013, je travaillais chez Cadremploi et nous avions besoin de faire évoluer le moteur de recherche du site qui fonctionnait uniquement avec Lucene. La promesse d&rsquo;Elasticsearch : un cœur Lucene, une recherche simplifiée (la syntaxe Lucene est étrange) disponible par une API REST et une base de données distribuée répliquée automatiquement. Le projet avait été un succès et avait été mis en production par l&rsquo;équipe suivante.</p>

<h4 id="2018-grdf">2018 - GrDF</h4>

<p>Retour à ElasticSearch chez GrDF qui souhaite accélérer sa recherche dans une de ses bases clientes. Environ 30 millions de clients présents dans la base et des nouveaux besoins de recherche : une recherche libre &ldquo;à la google&rdquo; ainsi qu&rsquo;une recherche par préfixe.</p>

<h2 id="les-changements"><strong>Les changements</strong></h2>

<p>Voyons maintenant ces changements qui m&rsquo;ont marqué.</p>

<h4 id="la-fin-des-plugins-site-embarqués">La fin des plugins &ldquo;site&rdquo; embarqués</h4>

<p>En 2013, la meilleure façon de visualiser son cluster ElasticSearch était d&rsquo;utiliser un plugin &ldquo;site&rdquo; comme <a href="https://github.com/mobz/elasticsearch-head">head</a> ou <a href="https://github.com/lmenezes/elasticsearch-kopf">kopf</a> (notez le lien entre les deux).
Une fois installée, ElasticSearch servait directement ces pages web sur son port 9200 (par défaut). Il y en de toute sorte, du monitoring de cluster aux tests des plugins phonétiques.
En octobre 2016, la version 5.0.0 d&rsquo;ElasticSearch sonnait la fin des plugins site notamment à cause de problèmes de sécurité (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.0/breaking_50_plugins.html#_site_plugins_removed">ici</a> et <a href="https://www.elastic.co/fr/blog/running-site-plugins-with-elasticsearch-5-0">là</a>).
Désormais, il faut embarquer un serveur indépendant pour pouvoir distribuer une fonctionnalité annexe à ElasticSearch. C&rsquo;est peut-être un peu contraignant, mais cela garantit une vraie indépendance des produits, indispensable quand on passe en production.</p>

<p>A noter que Kibana fournit un monitoring basique dans sa <a href="https://www.elastic.co/fr/subscriptions">version gratuite</a>.</p>

<p><img src="https://lh3.googleusercontent.com/n2KT8pW_-XWU9i9bWxY9iKcJLudH_f1PIrj1qODwWuJ7hKQVr_rlI4GTYuluWQBx0ix4Idr5=w640-h400-e365" alt="" />
Plugin head</p>

<h4 id="logstash-principal-point-d-entrée">Logstash, principal point d&rsquo;entrée</h4>

<p>Une façon d&rsquo;alimenter ElasticSearch était d&rsquo;utiliser une river, c&rsquo;est à dire un batch intégré à ElasticSearch capable de parcourir plus ou moins fréquemment une source pour en extraire les données.
Il y en avait plusieurs, en particulier pour extraire des données d&rsquo;une base de données (à partir d&rsquo;une requête), de CouchDB, RabbitMQ, Wikipedia ou encore Twitter.
Le problème venait de la consommation des ressources nécessaires (mémoire, sockets…) au bon fonctionnement du batch au détriment du fonctionnement d&rsquo;ElasticSearch.
En mars 2015, la version 2.0.0 <a href="https://www.elastic.co/blog/deprecating-rivers">les fait disparaitre</a> et ElasticSearch propose soit d&rsquo;extraire le code des rivers pour externaliser le fonctionnement ou d&rsquo;utiliser <a href="https://www.elastic.co/fr/products/logstash">LogStash</a> comme solution d&rsquo;approvisionnement.</p>

<p>Même si les rivers wikipedia ou twitter revêtaient un caractère pratique pour remplir sa base, dans un contexte de production, il y avait une vraie appréhension à en utiliser une, la question de la reprise sur erreur en cas de crash du nœud hébergeant la river étant difficilement solvable.</p>

<h4 id="le-ttl-est-mort">Le TTL est mort !</h4>

<p>Le <a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.3/mapping-ttl-field.html">TTL</a> (time to live) est une fonctionnalité que l&rsquo;on retrouve dans de nombreuses SGBD : lorsque vous ajoutez une donnée, vous pouvez préciser sa durée de vie. Une fois le temps écoulé, le système supprime automatiquement cette donnée.</p>

<p>Ce mécanisme peut sembler séduisant mais il présente de nombreux inconvénients : il faut fréquemment (60s) parcourir l&rsquo;ensemble des données pour détecter celles à supprimer mais également &ldquo;recompacter&rdquo; les fichiers dans lesquels on supprime ces données.
Le champ _timestamp (date d&rsquo;insertion de la donnée) est utilisé pour calculer le ttl.
La <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.0/breaking_50_mapping_changes.html#_literal__timestamp_literal_and_literal__ttl_literal">version 5.0.0 d&rsquo;ElasticSearch</a> supprime cette fonctionnalité précédemment dépréciée. Il est conseillé d&rsquo;utiliser sa propose date au lieu du champ timestamp (si nécessaire) et d&rsquo;utiliser des index temporels pour &ldquo;partitionner&rdquo; les données. De cette manière, il est facile de supprimer les données ajoutées au même moment en supprimant directement l&rsquo;index.</p>

<p>Si vous avez cependant besoin de définir des durées de vie différentes en fonction de vos données, il faudra gérer le mécanisme à la main : créer un champ spécial et appeler manuellement une requête <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete-by-query.html">&ldquo;delete_by_query&rdquo;</a>. Ce sera toujours plus efficace qu&rsquo;avec un ttl car le parcours et la suppression des données ne se fera qu&rsquo;une seule fois (et en utilisant les index).</p>

<p>De manière générale, je pense que les TTL sont une fausse bonne idée : ils dégradent les performances et une meilleure conception de sa structure de données permet d&rsquo;anticiper la question du nettoyage des données.</p>

<h4 id="la-gestion-avancée-du-type-de-données-string">La gestion avancée du type de données string</h4>

<p>De nombreux <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html">types de données</a> sont disponibles dans ES (dates, numériques, les tableaux…).<br />
Le type string, qui représente une chaîne de caractères, a vu son fonctionnement évoluer avec la version 5.0.0 (toujours la même).
Celle-ci introduit la séparation du type string en <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/text.html">text</a> et <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/keyword.html">keyword</a>. La nuance est importante car elle est influence directement la manière dont on recherche les données :</p>

<ul>
<li>Le type keyword représente un champ qui ne pourra être recherché que par sa valeur exacte et pourra être utilisé dans le filtrage, les agrégations et les tris. On privilégie ce champ pour des données de référentiels (code postaux, mails, statuts…). * Le type text représente un champ dans lequel on pourra rechercher une partie de texte.<br />
Il est toutefois possible d&rsquo;agréger / trier pour un type text en utilisant <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/fielddata.html">fielddata</a> lors du mapping.</li>
</ul>

<p>Ces nouvelles notions sont intéressantes car elles nous encouragent à mieux penser notre schéma de données en gardant bien à l&rsquo;esprit que la question la plus importante est &ldquo;comment je veux chercher mes données&rdquo;.</p>

<h4 id="la-fin-des-mapping-types">La fin des mapping types</h4>

<p>En étant légèrement grossier, on pourrait dire que les mapping types sont à un index Elasticsearch ce que les tables sont à un schéma sur une base de données.
On peut créer plusieurs mapping types sur un index, ce qui n&rsquo;implique pas pour autant de jointure. La version 7 d&rsquo;ElasticSearch va déprécier cet usage qui <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/removal-of-types.html">sera supprimé dans la version 8</a>.</p>

<p>Pourquoi ? Parce que lorsque sur un même index, on a deux mapping types différents mais que des champs ont le même nom (par exemple une date), ces champs doivent être de même type (string, int&hellip;). On peut supposer qu&rsquo;une date sera toujours du type date, mais parfois, on va avoir un long, une string…</p>

<p>La solution de contournement ? Un index pour chacun des mapping types (qui s&rsquo;appelle tous _doc). Elasticsearch permet de requêter dans plusieurs index en même temps (et même sur plusieurs clusters).</p>

<h4 id="multicast-vs-unicast">Multicast vs Unicast</h4>

<p>Je me rappelle encore de ma première installation d&rsquo;ElasticSearch : lors du premier démarrage, je regarde les logs et je vois le serveur commencer à discuter avec pleins de machines&hellip;mais que se passait-il ?</p>

<p>La raison était très simple : par défaut ElasticSearch était configuré en mode multicast, c&rsquo;est à dire qu&rsquo;il demandait sur le réseau si des copains voulaient bien jouer avec lui&hellip;autant dire que la première étape était de couper son serveur et d&rsquo;aller voir la doc (ce que j&rsquo;aurais surement dû faire depuis le début&hellip;)</p>

<p>La <a href="https://github.com/elastic/elasticsearch/pull/16326">version 5.0.0</a> supprime le plugin multicast, il faut désormais configurer le champ <em>discovery.zen.ping.unicast.hosts</em> afin de définir les nœuds à contacter (par défaut à 127.0.0.1).</p>

<h4 id="l-écosystème-étendu">L&rsquo;écosystème étendu</h4>

<p>En 2013, ElasticSearch était un produit isolé autour duquel gravitaient des outils de la communauté : des plugins, des outils. Kibana en est un parfait exemple (outil de dataviz).</p>

<p><img src="https://www.elastic.co/guide/en/kibana/6.1/monitoring/images/monitoring-kibana-instance.jpg" alt="RÃ©sultat de recherche d'images pour &quot;kibana 6 site:elastic.co&quot;" />
Exemple de dashboard avec Kibana</p>

<p>Les choses ont beaucoup changé et désormais, la suite Elastic s&rsquo;est agrandie :</p>

<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/keyword.html">Kibana</a> est pleinement intégré à Elastic et fournit des fonctionnalités de Dataviz, monitoring&hellip; * <a href="https://www.elastic.co/fr/products/logstash">Logstash</a> constitue un outil d&rsquo;approvisionnement d&rsquo;ElasticSearch (à la manière d&rsquo;un ETL) * <a href="https://www.elastic.co/fr/products/beats">Beats</a> et ses déclinaisons (<a href="https://www.elastic.co/fr/products/beats/filebeat">FileBeat</a>, <a href="https://www.elastic.co/fr/products/beats/metricbeat">MetricBeat</a>…) sont des agents permettant de collecter des métriques sur des machines et de les transférer, entre autre, vers ElasticSearch. * <a href="https://www.elastic.co/fr/products/stack">Suite Elastic</a> (anciennement X-pack) pour le monitoring et la gestion de la sécurité&hellip; * Bonus : avec la version 6.5 vient une fonctionnalité utile et inattendue, la <a href="https://www.elastic.co/fr/subscriptions">suppression de la licence gratuite</a> d&rsquo;un an pour l&rsquo;usage basique d&rsquo;ElasticSearch. C&rsquo;est un réel avantage car sur un petit cluster, devoir chaque année régénérer une licence pour la mettre à jour…c&rsquo;était fatigant.</li>
</ul>

<p><img src="/image-1.png" alt="" />
Outils de la Stack Elastic</p>

<h3 id="conclusion">Conclusion</h3>

<p>ElasticSearch a beaucoup évolué ces dernières années. Cela tient en partie aux nouveaux marchés qu&rsquo;il vise : à l&rsquo;origine, on utilisait uniquement ES pour faire de la recherche full-texte, le cas d&rsquo;usage était très précis et ça fonctionnait. Cela fait plusieurs années que le terme &ldquo;ELK&rdquo; est bien associé au stockage et à la recherche de log.</p>

<p>Désormais, la réorientation time-series du moteur ainsi que les nombreux outils annexes ouvrent la voie à de nouveaux usages comme le monitoring. Attention toutefois à ne pas toujours utiliser ElasticSearch en pensant qu&rsquo;il est le plus adapté car il &ldquo;sait&rdquo; le faire : InfluxDB est une solution particulièrement performante en terme de time-series, mais <a href="https://www.influxdata.com/products/editions/">plus onéreuse</a>.</p>

<p>Les cas que j&rsquo;ai traités dans cet article sont uniquement ceux auxquels j&rsquo;ai été confronté. N&rsquo;hésitez pas à commenter pour me faire part des évolutions qui vous ont particulièrement marqué.</p>
<div class="separator separator-danger"><img src='/img/talan_star_small.png'
                                                                 alt="Etoile Talan"/></div>
                </div>
            </div>

            <div class="col-md-3 col-md-offset-1 text-center right-column">
                <h3 class="social-title"><i class="fas fa-calendar-alt"></i> Date</h3>
                <time class="f6 mv4 dib tracked" datetime='2019-02-19T08:29:31Z'>
                    Publié le 19 février 2019
                </time>

                <h3 class="social-title"><i class="fas fa-pen"></i> Auteur</h3>
                <div class="author">
    <div class="avatar avatar-danger">
        
        <img alt="Avatar Jonathan BARANZINI" src='/img/jonathan_baranzini.jpg'>
        
    </div>
    <div class="description text-center">
        <h3 class="big-text">
            
            Jonathan BARANZINI
            
        </h3>
        <p class="small-text">Développeur</p>
    </div>
    <div class="social-buttons">
        
        
        
    </div>
</div>


                <h3 class="social-title"><i class="fas fa-flask"></i> Lab</h3>
                <div class="article-tags">
    
    <a class="badge badge-light" href='/categories/lab-s'>Lab S</a></div>


                <h3 class="social-title"><i class="fas fa-hashtag"></i> Tags</h3>
                <div class="article-tags">
    
    <a class="badge badge-light" href='/tags/elasticsearch'>#elasticsearch</a>
    <a class="badge badge-light" href='/tags/retour-dexperience'>#retour d&#39;experience</a></div>


            </div>
        </div>
    </div>
</div>

<div class="section">
    <div class="container">
        <h3 class="social-title"><i class="fas fa-comments"></i> Commentaires</h3>
        <div class="row">
            <div class="col-md-8">
                <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "labs-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
        </div>
    </div>
</div>




<div class="section">
    <div class="container">
        <h3 class="social-title"><i class="fas fa-forward"></i> Vous aimerez peut-être...</h3>
        <div class="card-deck">
        
            <a href="/datomic-base-de-donnees-noublie-rien/" class="card text-center">
    
    
    
    <div class="ribbon red"><span>Lab S</span></div>
    
    

    
    

    <div class="card-header">
        <h2 class="card-title">Datomic la base de données qui n&#39;oublie rien</h2>
        <span class="card-subtitle mb-2 text-muted">
            <strong>Timothé Fulcrand</strong>,
            <time class="post-date" datetime='2015-06-26T13:33:58Z'>
                le 26 juin 2015
            </time>
        </span>
    </div>

    <div class="card-body">
        <p class="card-text">Cette année à Devoxx au rayon Big Data on pouvait assister à la présentation de Datomic, une base de données NoSQL.</p>
    </div>

    <div class="card-footer">
        <div class="article-tags tags-margin">
    
    <span class="badge badge-light">Datomic</span></div>

        <div class="btn offer-link"><strong>Lire la suite</strong> <i class="fas fa-chevron-right"></i></div>
    </div>
</a>

        
        </div>
        
    </div>
</div>

</div><footer class="footer footer-big footer-blue">
    <div class="container">
        <div class="row">
            <div class="col-md-4 col-sm-4">
                <div class="info">
                    <h5 class="title">Les Labs de Talan</h5>
                    <nav>
                        <ul>
                            <li><a href='/categories/lab-0'><i class="fas fa-flask"></i> Lab Agilité</a></li>
                            <li><a href='/categories/lab-k'><i class="fas fa-flask"></i> Lab Blockchain</a></li>
                            <li><a href='/categories/lab-v'><i class="fas fa-flask"></i> Lab DevOps</a></li>
                            <li><a href='/categories/lab-9'><i class="fas fa-flask"></i> Lab Bootcamp</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
            <div class="col-md-4 col-sm-4">
                <div class="info">
                    <h5 class="title">Talan Labs</h5>
                    <nav>
                        <ul>
                            <li><a href="https://twitter.com/TalanLabs" target="_blank"><i class="fab fa-twitter"></i> Twitter</a></li>
                            <li><a href="https://www.linkedin.com/company/talanlabs/" target="_blank"><i class="fab fa-linkedin"></i> LinkedIn</a></li>
                            <li><a href="https://talan.com/metiers/labs/" target="_blank"><i class="fas fa-link"></i> Site web</a></li>
                            <li><a href="https://www.welcometothejungle.co/fr/companies/talanlabs/" target="_blank"><i class="fas fa-briefcase"></i> Welcome to the Jungle</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
            <div class="col-md-4 col-sm-4">
                <div class="info">
                    <h5 class="title">Le groupe Talan</h5>
                    <nav>
                        <ul>
                            <li><a href="https://twitter.com/talan_fr" target="_blank"><i class="fab fa-twitter"></i> Twitter</a></li>
                            <li><a href="https://www.linkedin.com/company/talan/" target="_blank"><i class="fab fa-linkedin"></i> LinkedIn</a></li>
                            <li><a href="https://www.facebook.com/talan/" target="_blank"><i class="fab fa-facebook"></i> Facebook</a></li>
                            <li><a href="https://talan.com/" target="_blank"><i class="fas fa-link"></i> Site web</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        <hr>
        <div class="copyright">© 2019 - Le Blog des Labs de Talan</div>
    </div>
</footer>
</body>


<script type="text/javascript" src='/js/jquery.min.js'></script>
<script type="text/javascript" src='/js/bootstrap.min.js'></script>


<script type="text/javascript" src='/js/modernizr.js'></script>

<script type="text/javascript" src='/js/fontawesome.min.js'></script>


<script type="text/javascript" src='/js/gaia.js'></script>

<script type="text/javascript" src='/js/custom.js'></script>
</html>
